# SURF-2022
Repository of programs written during my summer 2022 SURF internship at NIST Gaithersburg
Individual files are numbered. Files have been uploaded both individually and within a zip file. 

NMF:
1. [NMF.jl](https://github.com/marichard123/SURF-2022/blob/main/NMF.jl)- Located inside the first layer of the XRD folder. Reads in XRD data and outputs NMF constituent matrices. In the first few lines (lines 12-17), the user has the option to read in XRD data from either a pre-built matrix file, or from a collection of XRD .xy files from a directory. The user has the option of toggling whether the background is removed from XRD data before NMF is performed. Square root transform is off by default, option is present in presently commented-out code in line 269. NMF parameters toggleable in line 292. Weights/basis matrix written to directory in line 298.
2. [NMF_reconstructed_matrices.jl](https://github.com/marichard123/SURF-2022/blob/main/NMF_reconstructed_matrices.jl)- Located inside the first layer of the XRD folder. Mostly identical in function to the previously described NMF.jl file. In lines 301 to 307, however, the user defines a range of potential rank values for the weights matrix. NMF decomposition is performed within the function included within the loop for each rank value. A reconstructed approximation matrix is created by multiplying the weights and basis matrices, and each reconstructed matrix is saved to the directory with its name identifying its rank.
3. [nimfa_rank_estimate.py](https://github.com/marichard123/SURF-2022/blob/main/nimfa_rank_estimate.py)- Located inside the first layer of the XRD folder. Outputs residual calculations for a range of rank values of the weights matrix in the NMF decomposition. Matrix XRD data read in in line 19; range of ranks to be covered defined in line 29. Residual calculation files automatically written to directory.

Peak detection:

4. [peak_detection_model.py](https://github.com/marichard123/SURF-2022/blob/main/peak_detection_model.py)- Located inside XRD folder -> Peak Detection folder. Detects NMF basis vector peaks, displays detected peak locations superimposed on plots of NMF basis vectors and writes all detected peaks with their parameters to the directory in a CSV file. In line 9, the user may enter the minimum FWHM for a peak to be considered. In line 11, the user specifies the modifications made to the XRD data before NMF (any combination of background removal and square root transform) so that the changes may be reversed. The relevant files are also automatically selected; all relevant files are included in the directory along with peak_detection_model. Other criteria used to determine whether a peak is to be considered are defined in the function call in line 529.

Peak fitting:

5. [peak_fitting_looped.py](https://github.com/marichard123/SURF-2022/blob/main/peak_fitting_looped.py): Located inside XRD folder -> Peak Fitting folder. Meant as a quick preliminary test of fitting parameters. Peak profiles are fitted to the peaks of a single sample and a plot of the sample XRD pattern compared to the fit is shown. CSV files containing raw matrix data, two theta values, detected NMF basis peak parameters, and background values are read in in lines 37-41.Specific detected NMF basis peaks may be explicitly excluded from the model in line 10. The specific XRD pattern to be used is defined in line 26.
6. [peak_fitting_all_samples.py](https://github.com/marichard123/SURF-2022/blob/main/peak_fitting_all_samples.py): Located inside XRD folder -> Peak Fitting folder. Files read in/user-adjustable parameters are mostly identical to those of peak_fitting_looped. Peak profile fits are, however, automatically calculated for every sample in a dataset rather than for a single user-specified value. Three CSV files are written to the directory: a matrix representing the fitted peak patterns for every sample, a file containing the fitted parameters of every non-excluded peak in every sample, and a files containing the fitted profiles of every peak/the fitted background of every sample plotted independently of one another.
7. [Plotting_residual_matrices.m](https://github.com/marichard123/SURF-2022/blob/main/plotting_residual_matrices.m): Located inside XRD folder -> Peak Fitting folder. Matlab file that plays an animated plot of XRD patterns plotted against the fitted peak/background profiles. In lines 2-4 the user may specify whether to also plot peaks and background individually as components, whether to use a logarithmic scale and whether to mark fitted peaks with vertical lines. File names are specified in lines 6-16.

Gaussian Process:

8. [gaussian_process_regression_mean_squared_error.py](https://github.com/marichard123/SURF-2022/blob/main/gaussian_process_regression_mean_squared_error.py): Located inside XRD folder -> Gaussian Process folder. Reads in the CSV file of fitted peak parameters produced by peak_fitting_all_samples.py. Random subset of the points taken and a Gaussian process regression estimate produced for all points over the range of the wafer. Mean squared error of the estimate calculated, and uncertainty values (distance of one standard deviation from the mean) for every point saved to a CSV file. Surface plots of the estimate are produced. In lines 27-37, the peak and corresponding parameter to be considered, the pathways of the CSV files containing the fitted parameters and the percentage of original points to be included in the subset can be specified by the user.
9. [gaussian_process_regression_functionized.py](https://github.com/marichard123/SURF-2022/blob/main/gaussian_process_regression_functionized.py): Located inside XRD folder -> Gaussian Process folder. User input is of the same form as in gaussian_process_regression_mean_squared_error.py and may be specified in lines 24-28. The functionality of gaussian_process_regression_mean_squared_error.py is preserved. However, after every Gaussian Process regression estimate is performed and mean squared error is calculated, ten of the points with the highest uncertainty will be data to the data subset and the calculation will be re-performed. The user may specify the number of iterations in line 261.
